<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bin√§rPro ‚Äì Bin√§rumwandlung</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:#f6f7fb; color:#111; }
    .wrap { max-width: 1150px; margin:0 auto; padding:24px; }
    .card { background:#fff; border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.08); margin-top:14px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .top { display:flex; justify-content:space-between; align-items:flex-start; gap:14px; flex-wrap:wrap; }
    h1 { margin:0; font-size:1.8rem; }
    h2,h3 { margin:0 0 10px; }
    .muted { opacity:.8; }
    .pill { padding:8px 12px; border-radius:999px; background:#eef2ff; font-weight:900; }
    input { padding:10px 12px; border-radius:12px; border:1px solid #ccd2e1; font-size:1rem; }
    input[type="text"]{ min-width:240px; }
    button { padding:10px 14px; border-radius:12px; border:0; background:#1f6feb; color:#fff; font-weight:900; cursor:pointer; }
    button.ghost { background:#e5e7eb; color:#111; }
    a.ghost { text-decoration:none; padding:10px 14px; border-radius:12px; background:#e5e7eb; color:#111; font-weight:900; }

    .ok { background:#ecfdf5; border:1px solid #10b98144; padding:10px; border-radius:12px; }
    .bad { background:#fef2f2; border:1px solid #ef444444; padding:10px; border-radius:12px; }
    .feedback { margin-top:12px; display:none; }

    .quizBox{
      background:#0b2230;
      border-radius:18px;
      border:1px solid #0b2230;
      padding:18px;
      color:#f5c400;
    }

    .question{
      font-size:1.35rem;
      font-weight:1000;
      margin:0 0 10px;
      color:#f5c400;
    }

    .answerRow input{
      background:#0b2230;
      color:#f5c400;
      border:2px solid #f5c400;
      font-weight:1000;
      letter-spacing:.5px;
    }

    .answerRow input::placeholder{ color:#f5c400aa; }

    .sideGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:14px;
      align-items:start;
    }

    /* Default (breit): Highscore links, Hilfe rechts */
    .hsCard{ order: 1; }
    .helpCard{ order: 2; }

    /* Schmal: Hilfe oben, Highscore darunter */
    @media (max-width: 900px){
      .sideGrid{ grid-template-columns: 1fr; }
      .helpCard{ order: 1; }
      .hsCard{ order: 2; }
    }

    table{ width:100%; border-collapse: collapse; margin-top:10px; }
    th, td{ text-align:center; padding:8px; border:1px solid #e5e7eb; }
    th{ background:#f3f4f6; }

    .hintTableWrap{
      overflow-x:auto;
      border-radius:12px;
      border:1px solid #e5e7eb;
      background:#fff;
    }

    .hintTable{
      width:100%;
      min-width:520px;
      border-collapse: collapse;
      font-weight:900;
    }
    .hintTable th{
      background:#fff;
      font-size:1.2rem;
      padding:10px 12px;
    }
    .hintTable td{
      font-size:1.15rem;
      padding:10px 12px;
    }

    .exampleLine{
      margin-top:12px;
      font-size:1.3rem;
      text-align:center;
      font-weight:900;
    }
    .exampleLine span{ font-weight:1000; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .smallNote{ margin-top:10px; }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <h1>Bin√§rPro üî¢</h1>
          <div class="muted">
            90 Sekunden: Dezimalzahlen ‚Üî Bin√§rzahlen umwandeln. Schwierigkeit steigt mit der Zeit.
            Bis Aufgabe 15: max. 8 Bit, danach: max. 9 Bit.
          </div>
        </div>
        <a class="ghost" href="./index.html">‚Üê Startseite</a>
      </div>
    </div>

    <div class="card" id="loginCard">
      <h2>Sch√ºler-Code</h2>
      <div class="row">
        <input id="code" placeholder="Code (z.B. AB7K2)" style="text-transform:uppercase;" />
        <button id="loginBtn">Anmelden</button>
        <button class="ghost" id="logoutBtn" style="display:none;">Logout</button>
      </div>
      <div id="loginMsg" class="feedback"></div>
      <div class="muted smallNote">Tipp: Bin√§r darfst du mit Leerzeichen gruppieren (z.B. <span class="mono">0100 10110</span>).</div>
    </div>

    <div class="card" id="gameCard" style="display:none;">
      <div class="row" style="justify-content:space-between; align-items:flex-start;">
        <div>
          <div class="muted">Angemeldet als:</div>
          <div style="font-weight:1000; font-size:1.2rem;" id="studentName">‚Äî</div>
        </div>
        <div class="row">
          <span class="pill">Zeit: <span id="time">90</span>s</span>
          <span class="pill">Richtig: <span id="correct">0</span></span>
          <span class="pill">Streak: <span id="streak">0</span></span>
          <button class="ghost" id="refreshHsBtn">‚Üª Highscore</button>
        </div>
      </div>

      <div class="row" style="justify-content:center; margin-top:14px;">
        <button id="startBtn" style="padding:14px 22px; font-size:1.1rem; border-radius:16px;">‚ñ∂ START</button>
        <button id="stopBtn" class="ghost" style="display:none;">Stop</button>
      </div>

      <div id="runArea" style="display:none; margin-top:14px;">
        <div class="quizBox">
          <div class="question" id="question">‚Äî</div>
          <div class="row answerRow">
            <input id="answer" placeholder="Antwort eingeben‚Ä¶" autocomplete="off" />
            <button id="submitBtn">OK</button>
          </div>
          <div id="fb" class="feedback"></div>
        </div>

        <div class="sideGrid">
          <div class="card hsCard" style="box-shadow:none; border:1px solid #e5e7eb; background:#fafafa;">
            <h3>Highscore (Top 10)</h3>
            <div class="muted">Nach Anzahl richtiger Antworten in 90 Sekunden.</div>
            <div id="hsBox" class="muted">‚Äî</div>
          </div>

          <div class="card helpCard" style="box-shadow:none; border:1px solid #e5e7eb; background:#fafafa;">
            <h3>Hilfestellung: Stellenwerte (9 Bit)</h3>
            <div class="hintTableWrap">
              <table class="hintTable">
                <tr>
                  <th>256</th><th>128</th><th>64</th><th>32</th><th>16</th><th>8</th><th>4</th><th>2</th><th>1</th>
                </tr>
                <tr>
                  <td>0</td><td>1</td><td>0</td><td>0</td><td>1</td><td>0</td><td>1</td><td>1</td><td>0</td>
                </tr>
              </table>
            </div>
            <div class="exampleLine">
              128 + 16 + 4 + 2 = <span>150</span>
            </div>
            <div class="muted smallNote">
              Hinweis: F√ºhrende Nullen sind erlaubt. Du darfst auch weniger Bits eingeben.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://dnlencbwbbriijmzijci.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_G8SaY8-oyn7TcP-uH6neuA_PNqUR1x0";

    const FN_STUDENT_LOGIN = "https://dnlencbwbbriijmzijci.functions.supabase.co/student_login";
    const FN_GET_HIGHSCORES_BINARY = "https://dnlencbwbbriijmzijci.functions.supabase.co/get_highscores_binary";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id) => document.getElementById(id);

    const DURATION = 90;

    let studentId = null;
    let current = null; // { type: "d2b"|"b2d", dec:number, bin:string, bits:number }
    let t = DURATION;
    let timer = null;

    let correct = 0;
    let wrong = 0;
    let streak = 0;
    let questions = 0;

    function showMsg(el, ok, html){
      el.style.display = "block";
      el.className = "feedback " + (ok ? "ok" : "bad");
      el.innerHTML = html;
    }

    function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

    function toBin(n, bits){
      let s = n.toString(2);
      if (bits) s = s.padStart(bits, "0");
      return s;
    }

    function group4(bin){
      // Abstand nach je 4 Bits (von rechts)
      const s = bin.replace(/\s+/g,"");
      let out = "";
      for (let i=0;i<s.length;i++){
        out += s[i];
        const posFromEnd = s.length - i - 1;
        if (posFromEnd % 4 === 0 && i !== s.length - 1) out += " ";
      }
      return out;
    }

    function normalizeBinInput(s){
      return s.replace(/\s+/g, "").replace(/^0+(?=\d)/, ""); // spaces weg, f√ºhrende nullen weg (aber nicht alles l√∂schen)
    }

    function generateQuestion(){
      questions++;

      // bis Aufgabe 15: max 8 Bit, danach max 9 Bit
      const maxBits = (questions <= 15) ? 8 : 9;

      // Schwierigkeit steigt mit Zeit: je weniger Zeit, desto h√∂here Bits wahrscheinlicher
      const progress = 1 - (t / DURATION); // 0..1
      const minBits = 3 + Math.floor(progress * 4); // 3..7
      const bits = Math.max(3, Math.min(maxBits, randInt(minBits, maxBits)));

      const maxDec = (1 << bits) - 1;
      const dec = randInt(0, maxDec);
      const bin = toBin(dec, bits);

      const type = Math.random() < 0.5 ? "d2b" : "b2d";

      return { type, dec, bin, bits };
    }

    function renderQuestion(){
      current = generateQuestion();
      $("answer").value = "";
      $("answer").focus();

      if (current.type === "d2b"){
        $("question").textContent = `Wandle ${current.dec} ins Bin√§rsystem um.`;
        $("answer").placeholder = "z.B. 101 oder 0000 0101";
      } else {
        $("question").textContent = `Wandle ${group4(current.bin)} ins Dezimalsystem um.`;
        $("answer").placeholder = "z.B. 150";
      }
      $("fb").style.display = "none";
    }

    function tick(){
      t -= 1;
      $("time").textContent = String(t);
      if (t <= 0) stopGame(true);
    }

    function applyStreakBonus(){
      if (streak > 0 && streak % 3 === 0){
        t += 15;
        $("time").textContent = String(t);
        showMsg($("fb"), true, `üî• Streak ${streak}! <strong>+15 Sekunden</strong>`);
      }
    }

    function checkAnswer(){
      const input = $("answer").value.trim();
      if (!input) return;

      if (current.type === "d2b"){
        // Input as binary, allow spaces and leading zeros
        const clean = normalizeBinInput(input);
        if (!/^[01]+$/.test(clean)) {
          wrong++; streak = 0;
          $("streak").textContent = String(streak);
          showMsg($("fb"), false, "‚ùå Bitte nur 0 und 1 eingeben.");
          return;
        }

        const val = parseInt(clean, 2);
        if (val === current.dec){
          correct++; streak++;
          $("correct").textContent = String(correct);
          $("streak").textContent = String(streak);
          showMsg($("fb"), true, `‚úÖ Richtig! ${group4(current.bin)} = ${current.dec}`);
          applyStreakBonus();
          renderQuestion();
        } else {
          wrong++; streak = 0;
          $("streak").textContent = String(streak);
          showMsg($("fb"), false, `‚ùå Falsch. Tipp: Pr√ºfe die Stellenwerte. (${group4(current.bin)} w√§re richtig)`);
        }
      } else {
        // Input as decimal
        if (!/^\d+$/.test(input)){
          wrong++; streak = 0;
          $("streak").textContent = String(streak);
          showMsg($("fb"), false, "‚ùå Bitte eine Dezimalzahl eingeben (nur Ziffern).");
          return;
        }
        const val = Number(input);
        if (val === current.dec){
          correct++; streak++;
          $("correct").textContent = String(correct);
          $("streak").textContent = String(streak);
          showMsg($("fb"), true, `‚úÖ Richtig! ${group4(current.bin)} = ${current.dec}`);
          applyStreakBonus();
          renderQuestion();
        } else {
          wrong++; streak = 0;
          $("streak").textContent = String(streak);
          showMsg($("fb"), false, `‚ùå Falsch. ${group4(current.bin)} = ${current.dec}`);
        }
      }
    }

    async function startGame(){
      correct = 0;
      wrong = 0;
      streak = 0;
      questions = 0;

      t = DURATION;
      $("time").textContent = String(t);
      $("correct").textContent = "0";
      $("streak").textContent = "0";

      $("runArea").style.display = "block";
      $("stopBtn").style.display = "inline-block";
      $("startBtn").disabled = true;

      renderQuestion();

      if (timer) clearInterval(timer);
      timer = setInterval(tick, 1000);
    }

    async function stopGame(timeUp=false){
      if (timer) clearInterval(timer);
      timer = null;

      $("stopBtn").style.display = "none";
      $("startBtn").disabled = false;

      // Speichern (game "binary", mode "mix")
      // accuracy NOT NULL? -> setzen wir immer
      const total = correct + wrong;
      const accuracy = total > 0 ? (correct / total) : 0;

      const { error } = await supabase.from("attempts").insert({
        game: "binary",
        student_id: studentId,
        mode: "mix",
        correct_count: correct,
        wrong_count: wrong,
        total_count: total,
        accuracy: accuracy,
        duration_seconds: DURATION
      });

      if (error){
        showMsg($("loginMsg"), false, `Speichern fehlgeschlagen: ${error.message}`);
      } else {
        const txt = timeUp ? "‚è±Ô∏è Zeit abgelaufen." : "‚èπÔ∏è Gestoppt.";
        showMsg($("loginMsg"), true, `‚úÖ ${txt} Gespeichert: <strong>${correct}</strong> richtig.`);
      }

      await loadHighscores();
    }

    function renderHS(list){
      const el = $("hsBox");
      if (!list || !list.length){
        el.innerHTML = `<div class="muted">Noch keine Eintr√§ge.</div>`;
        return;
      }
      el.innerHTML = `
        <table>
          <thead><tr><th>#</th><th>Name</th><th>Richtig</th></tr></thead>
          <tbody>
            ${list.map((r,i)=>`
              <tr>
                <td class="muted">${i+1}</td>
                <td><strong>${String(r.name || "‚Äî")}</strong></td>
                <td>${Number(r.correct || r.score || r.correct_count || 0)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    async function loadHighscores(){
      $("hsBox").textContent = "Lade‚Ä¶";
      try{
        const res = await fetch(FN_GET_HIGHSCORES_BINARY, {
          method: "POST",
          headers: { "Content-Type":"application/json", "apikey": SUPABASE_ANON_KEY },
          body: JSON.stringify({})
        });
        const text = await res.text();
        let json = null;
        try { json = JSON.parse(text); } catch {}

        if (!res.ok || !json?.ok){
          $("hsBox").innerHTML = `<div class="bad">Highscore-Fehler</div>`;
          return;
        }

        // akzeptiere verschiedene R√ºckgabeformate
        const list = json.highscores || json.items || json.list || json.top || json.data || [];
        renderHS(list);
      } catch {
        $("hsBox").innerHTML = `<div class="bad">Netzwerkfehler</div>`;
      }
    }

    // ---- Login ----
    async function codeLogin(){
      const code = $("code").value.trim().toUpperCase();
      if (!code) { showMsg($("loginMsg"), false, "Bitte Code eingeben."); return; }

      try{
        const res = await fetch(FN_STUDENT_LOGIN, {
          method: "POST",
          headers: { "Content-Type":"application/json", "apikey": SUPABASE_ANON_KEY },
          body: JSON.stringify({ code })
        });

        const json = await res.json();
        if (!res.ok){
          showMsg($("loginMsg"), false, `‚ùå ${json.error || "Fehler"}${json.details ? " ‚Äì " + json.details : ""}`);
          return;
        }

        studentId = json.student.id;
        $("studentName").textContent = json.student.display_name;

        const { error: signErr } = await supabase.auth.signInWithPassword({ email: json.email, password: code });
        if (signErr){
          showMsg($("loginMsg"), false, `Login fehlgeschlagen: ${signErr.message}`);
          return;
        }

        $("logoutBtn").style.display = "inline-block";
        $("gameCard").style.display = "block";
        showMsg($("loginMsg"), true, `‚úÖ Willkommen, <strong>${json.student.display_name}</strong>!`);

        await loadHighscores();
      } catch(e){
        showMsg($("loginMsg"), false, `Netzwerkfehler: ${String(e)}`);
      }
    }

    async function logout(){
      studentId = null;
      $("logoutBtn").style.display = "none";
      $("gameCard").style.display = "none";
      $("runArea").style.display = "none";
      if (timer) clearInterval(timer);
      timer = null;
      await supabase.auth.signOut();
      showMsg($("loginMsg"), true, "Abgemeldet.");
    }

    // events
    $("loginBtn").addEventListener("click", codeLogin);
    $("code").addEventListener("keydown", (e)=>{ if (e.key==="Enter") codeLogin(); });
    $("logoutBtn").addEventListener("click", logout);

    $("startBtn").addEventListener("click", startGame);
    $("stopBtn").addEventListener("click", ()=> stopGame(false));

    $("submitBtn").addEventListener("click", checkAnswer);
    $("answer").addEventListener("keydown", (e)=>{ if (e.key==="Enter") checkAnswer(); });

    $("refreshHsBtn").addEventListener("click", loadHighscores);
  </script>
</body>
</html>
