<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bin√§rPro ‚Äì Bin√§rumwandlung</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:#f6f7fb; color:#111; }
    .wrap { max-width: 1150px; margin:0 auto; padding:24px; }
    .card { background:#fff; border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.08); margin-top:14px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .top { display:flex; justify-content:space-between; align-items:flex-start; gap:14px; flex-wrap:wrap; }
    h1 { margin:0; font-size:1.8rem; }
    h2,h3 { margin:0 0 10px; }
    .muted { opacity:.8; }
    .pill { padding:8px 12px; border-radius:999px; background:#eef2ff; font-weight:900; }
    input { padding:10px 12px; border-radius:12px; border:1px solid #ccd2e1; font-size:1rem; }
    input[type="text"]{ min-width:240px; }
    button { padding:10px 14px; border-radius:12px; border:0; background:#1f6feb; color:#fff; font-weight:900; cursor:pointer; }
    button.ghost { background:#e5e7eb; color:#111; }
    a.ghost { text-decoration:none; padding:10px 14px; border-radius:12px; background:#e5e7eb; color:#111; font-weight:900; }

    .ok { background:#ecfdf5; border:1px solid #10b98144; padding:10px; border-radius:12px; }
    .bad { background:#fef2f2; border:1px solid #ef444444; padding:10px; border-radius:12px; }
    .feedback { margin-top:12px; display:none; }

    .quizBox{
      background:#0b2230;
      border-radius:18px;
      border:1px solid #0b2230;
      padding:18px;
      color:#f5c400;
    }
    .question{
      font-size:1.35rem;
      font-weight:1000;
      margin:0 0 10px;
      color:#f5c400;
    }
    .answerRow input{
      background:#0b2230;
      color:#f5c400;
      border:2px solid #f5c400;
      font-weight:1000;
      letter-spacing:.5px;
    }
    .answerRow input::placeholder{ color:#f5c400aa; }

    .sideGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:14px;
      align-items:start;
    }
    .hsCard{ order: 1; }
    .helpCard{ order: 2; }

    @media (max-width: 900px){
      .sideGrid{ grid-template-columns: 1fr; }
      .helpCard{ order: 1; }
      .hsCard{ order: 2; }
    }

    table{ width:100%; border-collapse: collapse; margin-top:10px; }
    th, td{ text-align:center; padding:8px; border:1px solid #e5e7eb; }
    th{ background:#f3f4f6; }

    .hintTableWrap{
      overflow-x:auto;
      border-radius:12px;
      border:1px solid #e5e7eb;
      background:#fff;
    }
    .hintTable{
      width:100%;
      min-width:520px;
      border-collapse: collapse;
      font-weight:1000;
    }
    .hintTable th{
      background:#fff;
      font-size:1.15rem;
      padding:10px 12px;
    }
    .hintTable td{
      font-size:1.1rem;
      padding:10px 12px;
    }

    .exampleLine{
      margin-top:12px;
      font-size:1.25rem;
      text-align:center;
      font-weight:900;
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .smallNote{ margin-top:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <h1>Bin√§rPro üî¢</h1>
          <div class="muted">
            90 Sekunden: Dezimalzahlen ‚Üî Bin√§rzahlen umwandeln. Schwierigkeit steigt langsam.
            Bis Aufgabe 15: 8 Bit, danach: 9 Bit.
          </div>
        </div>
        <a class="ghost" href="./index.html">‚Üê Startseite</a>
      </div>
    </div>

    <div class="card" id="loginCard">
      <h2>Sch√ºler-Code</h2>
      <div class="row">
        <input id="code" placeholder="Code (z.B. AB7K2)" style="text-transform:uppercase;" />
        <button id="loginBtn">Anmelden</button>
        <button class="ghost" id="logoutBtn" style="display:none;">Logout</button>
      </div>
      <div id="loginMsg" class="feedback"></div>
      <div class="muted smallNote">
        Bin√§r darfst du mit Leerzeichen gruppieren (z.B. <span class="mono">0100 1011</span>).
        F√ºhrende Nullen sind erlaubt.
      </div>
    </div>

    <div class="card" id="gameCard" style="display:none;">
      <div class="row" style="justify-content:space-between; align-items:flex-start;">
        <div>
          <div class="muted">Angemeldet als:</div>
          <div style="font-weight:1000; font-size:1.2rem;" id="studentName">‚Äî</div>
        </div>
        <div class="row">
          <span class="pill">Zeit: <span id="time">90</span>s</span>
          <span class="pill">Richtig: <span id="correct">0</span></span>
          <span class="pill">Streak: <span id="streak">0</span></span>
          <button class="ghost" id="refreshHsBtn">‚Üª Highscore</button>
        </div>
      </div>

      <div class="row" style="justify-content:center; margin-top:14px;">
        <button id="startBtn" style="padding:14px 22px; font-size:1.1rem; border-radius:16px;">‚ñ∂ START</button>
        <button id="stopBtn" class="ghost" style="display:none;">Stop</button>
      </div>

      <div id="runArea" style="display:none; margin-top:14px;">
        <div class="quizBox">
          <div class="question" id="question">‚Äî</div>
          <div class="row answerRow">
            <input id="answer" placeholder="Antwort eingeben‚Ä¶" autocomplete="off" />
            <button id="submitBtn">OK</button>
          </div>
          <div id="fb" class="feedback"></div>
        </div>

        <div class="sideGrid">
          <div class="card hsCard" style="box-shadow:none; border:1px solid #e5e7eb; background:#fafafa;">
            <h3>Highscore (Top 10)</h3>
            <div class="muted">Nach Anzahl richtiger Antworten in 90 Sekunden.</div>
            <div id="hsBox" class="muted">‚Äî</div>
          </div>

          <div class="card helpCard" style="box-shadow:none; border:1px solid #e5e7eb; background:#fafafa;">
            <h3 id="helpTitle">Hilfestellung: Stellenwerte</h3>

            <div class="hintTableWrap">
              <table class="hintTable" id="hintTable">
                <!-- Dynamisch -->
              </table>
            </div>

            <div class="exampleLine" id="helpExample">‚Äî</div>

            <div class="muted smallNote" id="helpNote">
              Hinweis: F√ºhrende Nullen sind erlaubt. Du darfst auch weniger Bits eingeben.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://dnlencbwbbriijmzijci.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_G8SaY8-oyn7TcP-uH6neuA_PNqUR1x0";

    const FN_STUDENT_LOGIN = "https://dnlencbwbbriijmzijci.functions.supabase.co/student_login";
    const FN_GET_HIGHSCORES_BINARY = "https://dnlencbwbbriijmzijci.functions.supabase.co/get_highscores_binary";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const $ = (id) => document.getElementById(id);

    const DURATION = 90;

    let studentId = null;

    let current = null;     // { type:"b2d"|"d2b", dec:number, bin8:string, bits:number }
    let currentBits = 8;    // switches to 9 after question 15
    let helpFrozen = false; // after first 5 questions: freeze until bits jump

    let t = DURATION;
    let timer = null;

    let correct = 0;
    let wrong = 0;

    // streak counter that resets at 3
    let streakCounter = 0;

    let questions = 0;
    let lastDec = null;

    function showMsg(el, ok, html){
      el.style.display = "block";
      el.className = "feedback " + (ok ? "ok" : "bad");
      el.innerHTML = html;
    }

    function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

    function toBin(n, bits){
      let s = n.toString(2);
      return s.padStart(bits, "0");
    }

    // group from RIGHT in blocks of 4: 8-bit => "xxxx xxxx", 9-bit => "x xxxx xxxx"
    function group4(bin){
      const s = bin.replace(/\s+/g,"");
      let out = "";
      for (let i=0;i<s.length;i++){
        out += s[i];
        const posFromEnd = s.length - i - 1;
        if (posFromEnd % 4 === 0 && i !== s.length - 1) out += " ";
      }
      return out;
    }

    function normalizeBinInput(s){
      // remove spaces, allow leading zeros by parsing value; but for comparison we parse as int
      return s.replace(/\s+/g, "");
    }

    function bitsForQuestion(q){
      return (q <= 15) ? 8 : 9;
    }

    function pickDecForDifficulty(q, bits){
      // Slow ramp:
      // q 1-3: 0..31
      // q 4-6: 0..63
      // q 7-10: 0..127 (if bits=8), else up to 255 cap
      // q 11-15: 0..255 (8-bit max)
      // q 16+:  0..511 (9-bit max) with gradual ramp
      const maxByBits = (1 << bits) - 1;

      let max;
      if (q <= 3) max = 31;
      else if (q <= 6) max = 63;
      else if (q <= 10) max = Math.min(127, maxByBits);
      else if (q <= 15) max = Math.min(255, maxByBits);
      else {
        // 16.. end: ramp from 255 to maxByBits
        const ramp = Math.min(1, (q - 16) / 12); // after ~12 questions near full
        max = Math.round(255 + (maxByBits - 255) * ramp);
        max = Math.min(max, maxByBits);
      }

      // choose random but avoid same twice in a row
      let dec = randInt(0, max);
      for (let i=0;i<8 && dec === lastDec; i++){
        dec = randInt(0, max);
      }
      lastDec = dec;
      return dec;
    }

    function updateHelpTable(bits, binForRow=null){
      // bits is 8 or 9
      const table = $("hintTable");
      table.innerHTML = "";

      const weights = [];
      for (let i=bits-1; i>=0; i--) weights.push(1<<i);

      // header row
      const trH = document.createElement("tr");
      for (const w of weights){
        const th = document.createElement("th");
        th.textContent = String(w);
        trH.appendChild(th);
      }
      table.appendChild(trH);

      // bit row: if provided show actual current bin (bits-long)
      const trB = document.createElement("tr");
      if (binForRow){
        const s = binForRow.replace(/\s+/g,"").padStart(bits,"0").slice(-bits);
        for (let i=0;i<bits;i++){
          const td = document.createElement("td");
          td.textContent = s[i];
          trB.appendChild(td);
        }
      } else {
        // static example row (150) for 9bit, or 8bit
        // We'll use 150 if possible, otherwise 42
        const exDec = (bits >= 8) ? 150 : 42;
        const exBin = toBin(exDec, bits);
        for (let i=0;i<bits;i++){
          const td = document.createElement("td");
          td.textContent = exBin[i];
          trB.appendChild(td);
        }
      }
      table.appendChild(trB);

      // Title + Example line
      $("helpTitle").textContent = `Hilfestellung: Stellenwerte (${bits} Bit)`;

      const exDec2 = (bits >= 8) ? 150 : 42;
      const exBin2 = toBin(exDec2, bits);
      // build sum string
      const sumParts = [];
      for (let i=0;i<bits;i++){
        if (exBin2[i] === "1") sumParts.push(String(weights[i]));
      }
      $("helpExample").innerHTML = `${sumParts.join(" + ")} = <strong>${exDec2}</strong>`;
    }

    function generateQuestion(){
      questions++;
      const newBits = bitsForQuestion(questions);

      // when bits jump (8 -> 9), unfreeze help and rebuild static table
      if (newBits !== currentBits){
        currentBits = newBits;
        helpFrozen = false;             // allow rebuilding once on jump
        updateHelpTable(currentBits);   // static on new bits
        helpFrozen = true;              // then freeze again
      }

      // first 5 questions ALWAYS b2d
      const type = (questions <= 5) ? "b2d" : (Math.random() < 0.5 ? "b2d" : "d2b");

      const dec = pickDecForDifficulty(questions, currentBits);
      const bin = toBin(dec, currentBits);

      // For display requirement: show binary always as 8-bit in the question
      // even if MSBs are 0. After 15 it becomes 9-bit in help,
      // but question display stays 8-bit when asking b2d.
      const bin8Display = toBin(dec, 8);

      return { type, dec, bin, bin8Display, bits: currentBits };
    }

    function renderQuestion(){
      current = generateQuestion();
      $("answer").value = "";
      $("answer").focus();
      $("fb").style.display = "none";

      // HELP behavior:
      // first 5 examples: show current bin row in help table AND they are b2d
      if (questions <= 5){
        updateHelpTable(8, current.bin8Display); // show current bin in row
        helpFrozen = false; // not relevant yet
      } else {
        // after first 5: freeze the help table (keep as-is) until bits jump.
        if (!helpFrozen){
          // freeze using currentBits static table
          updateHelpTable(currentBits);
          helpFrozen = true;
        }
      }

      if (current.type === "b2d"){
        $("question").textContent = `Wandle ${group4(current.bin8Display)} ins Dezimalsystem um.`;
        $("answer").placeholder = "z.B. 150";
      } else {
        $("question").textContent = `Wandle ${current.dec} ins Bin√§rsystem um.`;
        $("answer").placeholder = "z.B. 101 oder 0000 0101";
      }
    }

    function tick(){
      t -= 1;
      $("time").textContent = String(t);
      if (t <= 0) stopGame(true);
    }

    function addStreakSuccess(){
      streakCounter += 1;
      if (streakCounter >= 3){
        streakCounter = 0; // reset after bonus
        t += 15;
        $("time").textContent = String(t);
        showMsg($("fb"), true, `üî• Streak! <strong>+15 Sekunden</strong>`);
      }
      $("streak").textContent = String(streakCounter);
    }

    function resetStreak(){
      streakCounter = 0;
      $("streak").textContent = "0";
    }

    function checkAnswer(){
      const input = $("answer").value.trim();
      if (!input) return;

      if (current.type === "d2b"){
        const clean = normalizeBinInput(input);

        if (!/^[01\s]+$/.test(input) || !/^[01]+$/.test(clean)){
          wrong++;
          resetStreak();
          showMsg($("fb"), false, "‚ùå Bitte nur 0 und 1 eingeben (Leerzeichen sind erlaubt).");
          return;
        }

        const val = parseInt(clean, 2);
        if (val === current.dec){
          correct++;
          $("correct").textContent = String(correct);
          addStreakSuccess();
          showMsg($("fb"), true, `‚úÖ Richtig! ${group4(toBin(current.dec, 8))} = ${current.dec}`);
          renderQuestion();
        } else {
          wrong++;
          resetStreak();
          showMsg($("fb"), false, `‚ùå Falsch. Richtig w√§re: ${group4(toBin(current.dec, 8))}`);
        }
      } else {
        if (!/^\d+$/.test(input)){
          wrong++;
          resetStreak();
          showMsg($("fb"), false, "‚ùå Bitte eine Dezimalzahl eingeben (nur Ziffern).");
          return;
        }

        const val = Number(input);
        if (val === current.dec){
          correct++;
          $("correct").textContent = String(correct);
          addStreakSuccess();
          showMsg($("fb"), true, `‚úÖ Richtig! ${group4(current.bin8Display)} = ${current.dec}`);
          renderQuestion();
        } else {
          wrong++;
          resetStreak();
          showMsg($("fb"), false, `‚ùå Falsch. ${group4(current.bin8Display)} = ${current.dec}`);
        }
      }
    }

    async function startGame(){
      correct = 0;
      wrong = 0;
      streakCounter = 0;
      questions = 0;
      lastDec = null;

      t = DURATION;
      $("time").textContent = String(t);
      $("correct").textContent = "0";
      $("streak").textContent = "0";

      currentBits = 8;
      helpFrozen = false;
      updateHelpTable(8); // initial static (will be overwritten during first 5)
      $("runArea").style.display = "block";
      $("stopBtn").style.display = "inline-block";
      $("startBtn").disabled = true;

      renderQuestion();

      if (timer) clearInterval(timer);
      timer = setInterval(tick, 1000);
    }

    async function stopGame(timeUp=false){
      if (timer) clearInterval(timer);
      timer = null;

      $("stopBtn").style.display = "none";
      $("startBtn").disabled = false;

      const total = correct + wrong;
      const accuracy = total > 0 ? (correct / total) : 0;

      const { error } = await supabase.from("attempts").insert({
        game: "binary",
        student_id: studentId,
        mode: "mix",
        correct_count: correct,
        wrong_count: wrong,
        total_count: total,
        accuracy: accuracy,
        duration_seconds: DURATION
      });

      if (error){
        showMsg($("loginMsg"), false, `Speichern fehlgeschlagen: ${error.message}`);
      } else {
        const txt = timeUp ? "‚è±Ô∏è Zeit abgelaufen." : "‚èπÔ∏è Gestoppt.";
        showMsg($("loginMsg"), true, `‚úÖ ${txt} Gespeichert: <strong>${correct}</strong> richtig.`);
      }

      await loadHighscores();
    }

    function renderHS(list){
      const el = $("hsBox");
      if (!list || !list.length){
        el.innerHTML = `<div class="muted">Noch keine Eintr√§ge.</div>`;
        return;
      }
      el.innerHTML = `
        <table>
          <thead><tr><th>#</th><th>Name</th><th>Richtig</th></tr></thead>
          <tbody>
            ${list.map((r,i)=>`
              <tr>
                <td class="muted">${i+1}</td>
                <td><strong>${String(r.name || "‚Äî")}</strong></td>
                <td>${Number(r.correct ?? r.score ?? r.correct_count ?? 0)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    async function loadHighscores(){
      $("hsBox").textContent = "Lade‚Ä¶";
      try{
        const res = await fetch(FN_GET_HIGHSCORES_BINARY, {
          method: "POST",
          headers: { "Content-Type":"application/json", "apikey": SUPABASE_ANON_KEY },
          body: JSON.stringify({})
        });
        const text = await res.text();
        let json = null;
        try { json = JSON.parse(text); } catch {}

        if (!res.ok || !json?.ok){
          $("hsBox").innerHTML = `<div class="bad">Highscore-Fehler</div>`;
          return;
        }

        const list = json.highscores || json.items || json.list || json.top || json.data || [];
        renderHS(list);
      } catch {
        $("hsBox").innerHTML = `<div class="bad">Netzwerkfehler</div>`;
      }
    }

    async function codeLogin(){
      const code = $("code").value.trim().toUpperCase();
      if (!code) { showMsg($("loginMsg"), false, "Bitte Code eingeben."); return; }

      try{
        const res = await fetch(FN_STUDENT_LOGIN, {
          method: "POST",
          headers: { "Content-Type":"application/json", "apikey": SUPABASE_ANON_KEY },
          body: JSON.stringify({ code })
        });

        const json = await res.json();
        if (!res.ok){
          showMsg($("loginMsg"), false, `‚ùå ${json.error || "Fehler"}${json.details ? " ‚Äì " + json.details : ""}`);
          return;
        }

        studentId = json.student.id;
        $("studentName").textContent = json.student.display_name;

        const { error: signErr } = await supabase.auth.signInWithPassword({ email: json.email, password: code });
        if (signErr){
          showMsg($("loginMsg"), false, `Login fehlgeschlagen: ${signErr.message}`);
          return;
        }

        $("logoutBtn").style.display = "inline-block";
        $("gameCard").style.display = "block";
        showMsg($("loginMsg"), true, `‚úÖ Willkommen, <strong>${json.student.display_name}</strong>!`);

        await loadHighscores();
      } catch(e){
        showMsg($("loginMsg"), false, `Netzwerkfehler: ${String(e)}`);
      }
    }

    async function logout(){
      studentId = null;
      $("logoutBtn").style.display = "none";
      $("gameCard").style.display = "none";
      $("runArea").style.display = "none";
      if (timer) clearInterval(timer);
      timer = null;
      await supabase.auth.signOut();
      showMsg($("loginMsg"), true, "Abgemeldet.");
    }

    $("loginBtn").addEventListener("click", codeLogin);
    $("code").addEventListener("keydown", (e)=>{ if (e.key==="Enter") codeLogin(); });
    $("logoutBtn").addEventListener("click", logout);

    $("startBtn").addEventListener("click", startGame);
    $("stopBtn").addEventListener("click", ()=> stopGame(false));

    $("submitBtn").addEventListener("click", checkAnswer);
    $("answer").addEventListener("keydown", (e)=>{ if (e.key==="Enter") checkAnswer(); });

    $("refreshHsBtn").addEventListener("click", loadHighscores);

    // initial help
    updateHelpTable(8);
    $("helpExample").innerHTML = `128 + 16 + 4 + 2 = <strong>150</strong>`;
  </script>
</body>
</html>
