<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bin√§rumwandlung ‚Äì 90s</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:#f6f7fb; color:#111; }
    .wrap { max-width: 1100px; margin:0 auto; padding:24px; }
    .card { background:#fff; border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.08); margin-top:14px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .top { display:flex; justify-content:space-between; align-items:flex-start; gap:14px; flex-wrap:wrap; }
    h1 { margin:0; font-size:1.8rem; }
    h2,h3 { margin:0 0 10px; }
    .muted { opacity:.8; }
    input { padding:10px 12px; border-radius:12px; border:1px solid #ccd2e1; font-size:1rem; min-width:240px; }
    button { padding:10px 14px; border-radius:12px; border:0; background:#1f6feb; color:#fff; font-weight:900; cursor:pointer; }
    button.ghost { background:#e5e7eb; color:#111; }
    a.ghost { text-decoration:none; padding:10px 14px; border-radius:12px; background:#e5e7eb; color:#111; font-weight:900; }
    .pill { padding:8px 12px; border-radius:999px; background:#eef2ff; font-weight:900; }
    .ok { background:#ecfdf5; border:1px solid #10b98144; padding:10px; border-radius:12px; }
    .bad { background:#fef2f2; border:1px solid #ef444444; padding:10px; border-radius:12px; }
    .feedback { margin-top:12px; display:none; }

    .startBar { display:flex; justify-content:center; margin-top:14px; }
    .startBtn { padding:14px 22px; font-size:1.1rem; border-radius:16px; }

    .statsRow { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-top:14px; }
    .taskBox { background:#f9fafb; border:1px solid #e5e7eb; border-radius:16px; padding:14px; margin-top:12px; }
    .task { font-size:1.8rem; font-weight:1000; }

    .twoCol { display:grid; grid-template-columns: 1fr 1fr; gap:14px; margin-top:12px; }
    @media (max-width: 820px){ .twoCol { grid-template-columns: 1fr; } }

    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:8px; border-bottom:1px solid #e5e7eb; }
    th { font-size:.9rem; opacity:.9; }

    .helpGrid { display:grid; grid-template-columns: repeat(12, 1fr); gap:6px; }
    .helpCell { background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:8px; text-align:center; }
    .helpTop { font-weight:1000; font-size:.9rem; }
    .helpBottom { opacity:.8; font-size:.85rem; margin-top:3px; }
    .tiny { font-size:.9rem; }

    .sectionTitle { display:flex; justify-content:space-between; align-items:baseline; gap:8px; }
    .miniBtn { padding:8px 10px; border-radius:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <h1>Bin√§rumwandlung üß† (90s)</h1>
          <div class="muted">
            90 Sekunden ‚Äì Aufgaben werden mit der Zeit schwieriger (bis 15. Aufgabe nur 8 Bit, danach bis 12 Bit).
          </div>
        </div>
        <a class="ghost" href="./index.html">‚Üê Startseite</a>
      </div>
    </div>

    <div class="card" id="loginCard">
      <h2>Sch√ºler-Code</h2>
      <div class="row">
        <input id="code" placeholder="Code (z.B. AB7K2)" style="text-transform:uppercase;" />
        <button id="loginBtn">Anmelden</button>
        <button class="ghost" id="logoutBtn" style="display:none;">Logout</button>
      </div>
      <div id="loginMsg" class="feedback"></div>
      <div class="muted" style="margin-top:10px;">Derselbe Code funktioniert auf mehreren Ger√§ten.</div>
    </div>

    <div class="card" id="gameCard" style="display:none;">
      <div class="row" style="justify-content:space-between; align-items:flex-start;">
        <div>
          <div class="muted">Angemeldet als:</div>
          <div style="font-weight:1000; font-size:1.2rem;" id="studentName">‚Äî</div>
        </div>
        <div class="row">
          <button class="ghost miniBtn" id="refreshHsBtn" type="button">‚Üª Highscore</button>
        </div>
      </div>

      <div class="startBar" id="startBar">
        <button id="startBtn" class="startBtn" type="button">‚ñ∂ START</button>
      </div>

      <div id="runArea" style="display:none;">
        <div class="statsRow">
          <div class="pill">Zeit: <span id="time">90</span>s</div>
          <div class="pill">Aufgabe: <span id="qnum">0</span></div>
          <div class="pill">Richtig: <span id="right">0</span></div>
          <div class="pill">Falsch: <span id="wrong">0</span></div>
          <div class="pill">Accuracy: <span id="acc">0%</span></div>
          <button class="ghost miniBtn" id="stopBtn" type="button">Stop</button>
        </div>

        <div class="taskBox">
          <div class="muted">Aufgabe:</div>
          <div id="task" class="task">‚Äî</div>
          <div class="muted tiny" id="taskHint">‚Äî</div>
        </div>

        <div class="row" style="margin-top:12px;">
          <input id="answer" autocomplete="off" placeholder="Antwort‚Ä¶" />
          <button id="okBtn" type="button">OK</button>
        </div>

        <div id="fb" class="feedback"></div>
      </div>

      <div class="twoCol">
        <div class="card" style="box-shadow:none; border:1px solid #e5e7eb; background:#fafafa;">
          <div class="sectionTitle">
            <h3>Highscore (Top 10)</h3>
          </div>
          <div class="muted tiny">Sortierung: nach <strong>richtigen Antworten</strong> (ein Durchgang).</div>
          <div id="hsBox" class="muted" style="margin-top:10px;">‚Äî</div>
        </div>

        <div class="card" style="box-shadow:none; border:1px solid #e5e7eb; background:#fafafa;">
          <div class="sectionTitle">
            <h3>Hilfe: Stellenwerte (12 Bit)</h3>
          </div>
          <div class="muted tiny">Du darfst die Bin√§rzahl mit beliebig vielen f√ºhrenden Nullen oder weniger Bits eingeben (z.B. 101, 00000101, 000000000101).</div>

          <div id="helpGrid" class="helpGrid" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://dnlencbwbbriijmzijci.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_G8SaY8-oyn7TcP-uH6neuA_PNqUR1x0";

    const FN_STUDENT_LOGIN = "https://dnlencbwbbriijmzijci.functions.supabase.co/student_login";
    const FN_GET_HIGHSCORES_BINARY = "https://dnlencbwbbriijmzijci.functions.supabase.co/get_highscores_binary";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const DURATION = 90;
    const $ = (id) => document.getElementById(id);

    const loginMsg = $("loginMsg");
    const fb = $("fb");

    let studentId = null;
    let studentName = null;

    let t = DURATION;
    let timer = null;

    let right = 0;
    let wrong = 0;

    let qnum = 0;         // wie viele Aufgaben beantwortet
    let expectType = "";  // "bin" oder "dec"
    let targetValue = 0;  // immer als Dezimalwert speichern
    let showBits = 8;     // wie viele Bits beim Anzeigen (8 oder bis 12)

    function showMsg(el, ok, text) {
      el.style.display = "block";
      el.className = "feedback " + (ok ? "ok" : "bad");
      el.innerHTML = text;
    }

    function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }

    function updateUI(){
      const total = right + wrong;
      const acc = total > 0 ? right/total : 0;
      $("time").textContent = String(t);
      $("qnum").textContent = String(qnum);
      $("right").textContent = String(right);
      $("wrong").textContent = String(wrong);
      $("acc").textContent = Math.round(acc*100) + "%";
    }

    function bitsForNow(){
      // Schwierigkeit steigt mit Zeit: 3..12 Bits (linear), aber bis Aufgabe 15 max 8 Bit
      const elapsed = DURATION - t; // 0..90
      const dynBits = Math.min(12, 3 + Math.floor(elapsed / 8)); // ca. alle 8s +1 Bit
      const cap = (qnum < 15) ? 8 : 12;
      return Math.min(dynBits, cap);
    }

    function toBin(n, bits){
      let s = n.toString(2);
      // f√ºr Anzeige: pad auf bits
      if (s.length < bits) s = "0".repeat(bits - s.length) + s;
      return s;
    }

    function newTask(){
      showBits = bitsForNow();

      // zuf√§llig Richtung: bin->dec oder dec->bin
      const dir = Math.random() < 0.5 ? "binToDec" : "decToBin";

      // Wertebereich abh√§ngig von Bits
      const maxVal = (1 << showBits) - 1;
      // damit 0 nicht zu oft kommt, aber m√∂glich ist:
      targetValue = randInt(0, maxVal);

      if (dir === "binToDec") {
        expectType = "dec";
        const binShown = toBin(targetValue, showBits);
        $("task").textContent = `${binShown} (bin)  ‚Üí  ? (dez)`;
        $("taskHint").textContent = `Gib eine Dezimalzahl ein (0‚Äì${maxVal}).`;
        $("answer").inputMode = "numeric";
        $("answer").placeholder = "Dezimalzahl‚Ä¶";
      } else {
        expectType = "bin";
        const decShown = targetValue;
        $("task").textContent = `${decShown} (dez)  ‚Üí  ? (bin)`;
        $("taskHint").textContent = `Gib eine Bin√§rzahl ein (nur 0/1). L√§nge egal (z.B. 101 oder 00000101).`;
        $("answer").inputMode = "text";
        $("answer").placeholder = "Bin√§rzahl‚Ä¶";
      }

      $("answer").value = "";
      $("answer").focus();
    }

    function check(){
      const raw = $("answer").value.trim();

      if (expectType === "dec") {
        if (!/^\d+$/.test(raw)) { showMsg(fb, false, "‚ö†Ô∏è Bitte nur Ziffern eingeben."); return; }
        const ans = Number(raw);
        if (ans === targetValue) {
          right++; showMsg(fb, true, "‚úÖ Richtig!");
        } else {
          wrong++; showMsg(fb, false, `‚ùå Falsch. Richtig w√§re <strong>${targetValue}</strong>.`);
        }
      } else {
        if (!/^[01]+$/.test(raw)) { showMsg(fb, false, "‚ö†Ô∏è Bitte nur 0 und 1 eingeben."); return; }
        // f√ºhrende Nullen egal: parseInt klappt
        const ans = parseInt(raw, 2);
        if (ans === targetValue) {
          right++; showMsg(fb, true, "‚úÖ Richtig!");
        } else {
          wrong++;
          const show = toBin(targetValue, showBits);
          showMsg(fb, false, `‚ùå Falsch. Richtig w√§re z.B. <strong>${show}</strong> (oder ohne f√ºhrende Nullen).`);
        }
      }

      qnum++;
      updateUI();
      newTask();
    }

    function tick(){
      t -= 1;
      updateUI();
      if (t <= 0) stop();
    }

    async function startRun(){
      t = DURATION;
      right = 0;
      wrong = 0;
      qnum = 0;

      fb.style.display = "none";
      $("startBar").style.display = "none";
      $("runArea").style.display = "block";

      updateUI();
      newTask();

      if (timer) clearInterval(timer);
      timer = setInterval(tick, 1000);
    }

    async function stop(){
      if (timer) clearInterval(timer);
      timer = null;

      $("runArea").style.display = "none";
      $("startBar").style.display = "flex";

      const total = right + wrong;
      const accuracy = total > 0 ? (right / total) : 0;

      const { error } = await supabase.from("attempts").insert({
        game: "binary",
        student_id: studentId,
        mode: "mix",
        correct_count: right,
        wrong_count: wrong,
        total_count: total,
        accuracy: accuracy,
        duration_seconds: DURATION
      });

      if (error) {
        showMsg(loginMsg, false, `Speichern fehlgeschlagen: ${error.message}`);
      } else {
        showMsg(loginMsg, true, `‚úÖ Gespeichert: Richtig <strong>${right}</strong>, Falsch <strong>${wrong}</strong>, Accuracy <strong>${Math.round(accuracy*100)}%</strong>`);
      }

      await loadHighscores();
    }

    function renderHS(list){
      const el = $("hsBox");
      if (!list || !list.length) {
        el.innerHTML = `<div class="muted">Noch keine Eintr√§ge.</div>`;
        return;
      }
      el.innerHTML = `
        <table>
          <thead><tr><th>#</th><th>Name</th><th>Richtig</th></tr></thead>
          <tbody>
            ${list.map((r, i) => `
              <tr>
                <td class="muted">${i+1}</td>
                <td><strong>${String(r.name || "‚Äî")}</strong></td>
                <td>${Number(r.correct || 0)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    async function loadHighscores(){
      $("hsBox").textContent = "Lade‚Ä¶";
      try {
        const res = await fetch(FN_GET_HIGHSCORES_BINARY, {
          method: "POST",
          headers: { "Content-Type":"application/json", "apikey": SUPABASE_ANON_KEY },
          body: JSON.stringify({})
        });
        const json = await res.json();
        if (!res.ok || !json.ok) {
          $("hsBox").innerHTML = `<div class="bad">Highscore-Fehler</div>`;
          return;
        }
        renderHS(json.top10);
      } catch {
        $("hsBox").innerHTML = `<div class="bad">Netzwerkfehler</div>`;
      }
    }

    function renderHelp(){
      const weights = [];
      for (let i=11;i>=0;i--) weights.push(2**i); // 2048..1
      const grid = $("helpGrid");
      grid.innerHTML = weights.map(w => `
        <div class="helpCell">
          <div class="helpTop">${w}</div>
          <div class="helpBottom">${w.toString(2)}</div>
        </div>
      `).join("");
    }

    async function codeLogin(){
      const code = $("code").value.trim().toUpperCase();
      if (!code) { showMsg(loginMsg, false, "Bitte Code eingeben."); return; }

      try {
        const res = await fetch(FN_STUDENT_LOGIN, {
          method: "POST",
          headers: { "Content-Type":"application/json", "apikey": SUPABASE_ANON_KEY },
          body: JSON.stringify({ code })
        });

        const json = await res.json();
        if (!res.ok) {
          showMsg(loginMsg, false, `‚ùå ${json.error || "Fehler"}${json.details ? " ‚Äì " + json.details : ""}`);
          return;
        }

        const email = json.email;
        studentId = json.student.id;
        studentName = json.student.display_name;

        const { error: signErr } = await supabase.auth.signInWithPassword({ email, password: code });
        if (signErr) {
          showMsg(loginMsg, false, `Login fehlgeschlagen: ${signErr.message}`);
          return;
        }

        $("studentName").textContent = studentName;
        $("logoutBtn").style.display = "inline-block";
        $("gameCard").style.display = "block";

        $("startBar").style.display = "flex";
        $("runArea").style.display = "none";

        showMsg(loginMsg, true, `‚úÖ Willkommen, <strong>${studentName}</strong>!`);
        renderHelp();
        await loadHighscores();
      } catch (e) {
        showMsg(loginMsg, false, `Netzwerkfehler: ${String(e)}`);
      }
    }

    async function logout(){
      studentId = null;
      studentName = null;
      $("logoutBtn").style.display = "none";
      $("gameCard").style.display = "none";
      await supabase.auth.signOut();
      showMsg(loginMsg, true, "Abgemeldet.");
    }

    // Events
    $("loginBtn").addEventListener("click", codeLogin);
    $("code").addEventListener("keydown", (e) => { if (e.key === "Enter") codeLogin(); });
    $("logoutBtn").addEventListener("click", logout);

    $("startBtn").addEventListener("click", startRun);
    $("okBtn").addEventListener("click", check);
    $("stopBtn").addEventListener("click", stop);
    $("answer").addEventListener("keydown", (e) => { if (e.key === "Enter") check(); });

    $("refreshHsBtn").addEventListener("click", loadHighscores);
  </script>
</body>
</html>
