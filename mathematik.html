<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mathematik – Einmaleins (mit Code)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:#f6f7fb; color:#111; }
    .wrap { max-width: 980px; margin:0 auto; padding:24px; }
    .card { background:#fff; border-radius:14px; padding:18px; box-shadow:0 8px 24px rgba(0,0,0,.08); margin-top:14px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    input { padding:10px 12px; border-radius:10px; border:1px solid #ccd2e1; font-size:1rem; min-width:240px; }
    button { padding:10px 14px; border-radius:10px; border:0; background:#1f6feb; color:#fff; font-weight:900; cursor:pointer; }
    button.secondary { background:#111827; }
    button.ghost { background:#e5e7eb; color:#111; }
    a.ghost { text-decoration:none; padding:10px 14px; border-radius:10px; background:#e5e7eb; color:#111; font-weight:900; }
    .pill { padding:6px 10px; border-radius:999px; background:#eef2ff; font-weight:900; }
    .muted { opacity:.8; }
    .ok { background:#ecfdf5; border:1px solid #10b98144; padding:10px; border-radius:10px; }
    .bad { background:#fef2f2; border:1px solid #ef444444; padding:10px; border-radius:10px; }
    .feedback { margin-top:12px; display:none; }
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { text-align:left; padding:8px; border-bottom:1px solid #e5e7eb; }
    th { font-size:.9rem; opacity:.9; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <h1 style="margin:0;">Mathematik – Einmaleins ⚡ (120s)</h1>
        <a class="ghost" href="./index.html">← Startseite</a>
      </div>
      <p class="muted" style="margin:10px 0 0;">
        Login mit Schüler-Code. Gespeichert werden richtig, falsch, Gesamt und Verhältnis (Accuracy).
      </p>
    </div>

    <div class="card" id="loginCard">
      <h2 style="margin-top:0;">Schüler-Code</h2>
      <div class="row">
        <input id="code" placeholder="Code (z.B. AB7K2)" style="text-transform:uppercase;" />
        <button id="claimBtn">Anmelden</button>
        <button class="ghost" id="logoutBtn" style="display:none;">Logout</button>
      </div>
      <div id="loginMsg" class="feedback"></div>
      <div class="muted" style="margin-top:10px;">
        Falls der Code „schon benutzt“ ist, bitte Lehrperson fragen.
      </div>
    </div>

    <div class="card" id="gameCard" style="display:none;">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="muted">Angemeldet als:</div>
          <div style="font-weight:900; font-size:1.1rem;" id="studentName">—</div>
        </div>
        <div class="row">
          <button id="smallBtn">Kleines 1×1</button>
          <button id="bigBtn" class="secondary">Großes 1×1</button>
        </div>
      </div>

      <div id="runArea" style="display:none; margin-top:14px;">
        <div class="row" style="justify-content:space-between;">
          <div class="pill">Zeit: <span id="time">120</span>s</div>
          <div class="pill">Richtig: <span id="right">0</span></div>
          <div class="pill">Falsch: <span id="wrong">0</span></div>
          <div class="pill">Accuracy: <span id="acc">0%</span></div>
          <div class="pill">Streak: <span id="streak">0</span></div>
        </div>

        <div style="margin-top:14px;">
          <div class="muted">Rechnung:</div>
          <div id="task" style="font-size:1.8rem; font-weight:900;">—</div>
        </div>

        <div class="row" style="margin-top:12px;">
          <input id="answer" inputmode="numeric" autocomplete="off" placeholder="Ergebnis…" />
          <button id="okBtn">OK</button>
          <button class="ghost" id="stopBtn">Stop</button>
        </div>

        <div id="fb" class="feedback"></div>
      </div>

      <div id="historyArea" style="margin-top:14px;">
        <h3 style="margin:0 0 8px;">Meine Entwicklung</h3>
        <div id="statsBox" class="muted">—</div>
        <div id="historyBox" class="muted">—</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://dnlencbwbbriijmzijci.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_G8SaY8-oyn7TcP-uH6neuA_PNqUR1x0";
    const FN_CLAIM_CODE = "https://dnlencbwbbriijmzijci.functions.supabase.co/claim_code";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const DURATION = 120;
    const $ = (id) => document.getElementById(id);

    const loginMsg = $("loginMsg");
    const fb = $("fb");

    let studentId = null;
    let studentName = null;

    let mode = "small";
    let max = 10;

    let t = DURATION;
    let timer = null;

    let right = 0;
    let wrong = 0;
    let streak = 0;
    let bestStreak = 0;

    let a = 0, b = 0;

    function showMsg(el, ok, text) {
      el.style.display = "block";
      el.className = "feedback " + (ok ? "ok" : "bad");
      el.innerHTML = text;
    }

    function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }

    function updateAccUI() {
      const total = right + wrong;
      const acc = total > 0 ? (right / total) : 0;
      $("acc").textContent = Math.round(acc * 100) + "%";
      $("right").textContent = String(right);
      $("wrong").textContent = String(wrong);
      $("streak").textContent = String(streak);
    }

    function newTask(){
      a = randInt(1, max);
      b = randInt(1, max);
      $("task").textContent = `${a} × ${b} = ?`;
      $("answer").value = "";
      $("answer").focus();
    }

    function tick(){
      t -= 1;
      $("time").textContent = String(t);
      if (t <= 0) stop(true);
    }

    async function startRun(selectedMode){
      mode = selectedMode;
      max = mode === "small" ? 10 : 20;

      t = DURATION;
      right = 0;
      wrong = 0;
      streak = 0;
      bestStreak = 0;

      $("time").textContent = String(DURATION);
      fb.style.display = "none";

      updateAccUI();

      $("runArea").style.display = "block";
      newTask();

      if (timer) clearInterval(timer);
      timer = setInterval(tick, 1000);
    }

    function check(){
      const raw = $("answer").value.trim();
      if (!/^\d+$/.test(raw)) { showMsg(fb, false, "⚠️ Bitte nur Ziffern eingeben."); return; }

      const ans = Number(raw);
      const correct = a * b;

      if (ans === correct) {
        right += 1;
        streak += 1;
        bestStreak = Math.max(bestStreak, streak);
        showMsg(fb, true, "✅ Richtig!");
      } else {
        wrong += 1;
        streak = 0;
        showMsg(fb, false, `❌ Falsch. Richtig wäre <strong>${correct}</strong>. Nächste!`);
      }

      updateAccUI();
      newTask();
    }

    async function stop(fromTimer){
      if (timer) clearInterval(timer);
      timer = null;
      $("runArea").style.display = "none";

      const total = right + wrong;
      const accuracy = total > 0 ? (right / total) : 0;

      const { error } = await supabase.from("attempts").insert({
        student_id: studentId,
        mode,
        correct_count: right,
        wrong_count: wrong,
        total_count: total,
        accuracy: accuracy,
        duration_seconds: DURATION
      });

      if (error) {
        showMsg(loginMsg, false, `Speichern fehlgeschlagen: ${error.message}`);
      } else {
        showMsg(
          loginMsg,
          true,
          `✅ Gespeichert: Richtig <strong>${right}</strong>, Falsch <strong>${wrong}</strong>, Gesamt <strong>${total}</strong>, Accuracy <strong>${Math.round(accuracy*100)}%</strong> (${mode === "small" ? "klein" : "groß"}), beste Streak: ${bestStreak}`
        );
      }

      await loadHistory();
    }

    async function loadHistory(){
      $("statsBox").textContent = "Lade Statistik…";
      $("historyBox").textContent = "Lade Verlauf…";

      const { data, error } = await supabase
        .from("attempts")
        .select("mode,correct_count,wrong_count,total_count,accuracy,created_at")
        .eq("student_id", studentId)
        .order("created_at", { ascending: false })
        .limit(50);

      if (error) {
        $("statsBox").innerHTML = `<div class="bad">Fehler: ${error.message}</div>`;
        $("historyBox").textContent = "—";
        return;
      }

      const attempts = data || [];
      if (!attempts.length) {
        $("statsBox").innerHTML = `<div class="muted">Noch keine Versuche gespeichert.</div>`;
        $("historyBox").textContent = "—";
        return;
      }

      const bestCorrect = attempts.reduce((m,a)=>Math.max(m,a.correct_count),0);
      const bestAcc = attempts.reduce((m,a)=>Math.max(m,Number(a.accuracy ?? 0)),0);

      const last5 = attempts.slice(0,5);
      const avgAcc5 = last5.length ? (last5.reduce((s,a)=>s+Number(a.accuracy ?? 0),0)/last5.length) : 0;

      $("statsBox").innerHTML = `
        <div class="ok">
          Bestwert richtig: <strong>${bestCorrect}</strong>
          &nbsp;|&nbsp; Beste Accuracy: <strong>${Math.round(bestAcc*100)}%</strong>
          &nbsp;|&nbsp; Ø Accuracy letzte 5: <strong>${Math.round(avgAcc5*100)}%</strong>
        </div>
      `;

      $("historyBox").innerHTML = `
        <table>
          <thead><tr><th>Datum</th><th>Modus</th><th>Richtig</th><th>Falsch</th><th>Gesamt</th><th>Accuracy</th></tr></thead>
          <tbody>
            ${attempts.map(a => {
              const d = new Date(a.created_at).toLocaleString("de-AT");
              const acc = Math.round(Number(a.accuracy ?? 0) * 100) + "%";
              return `<tr>
                <td class="muted">${d}</td>
                <td>${a.mode === "small" ? "Klein" : "Groß"}</td>
                <td><strong>${a.correct_count}</strong></td>
                <td>${a.wrong_count ?? 0}</td>
                <td class="muted">${a.total_count ?? (a.correct_count + (a.wrong_count ?? 0))}</td>
                <td class="muted">${acc}</td>
              </tr>`;
            }).join("")}
          </tbody>
        </table>
      `;
    }

    async function ensureAnonSession(){
      const { data } = await supabase.auth.getSession();
      if (data.session) return;
      await supabase.auth.signInAnonymously();
    }

    async function claimCode(){
      await ensureAnonSession();

      const code = $("code").value.trim().toUpperCase();
      if (!code) { showMsg(loginMsg, false, "Bitte Code eingeben."); return; }

      const { data: sessionData } = await supabase.auth.getSession();
      const token = sessionData.session?.access_token;
      if (!token) { showMsg(loginMsg, false, "Kein Token. Bitte Seite neu laden."); return; }

      try {
        const res = await fetch(FN_CLAIM_CODE, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`,
            "apikey": SUPABASE_ANON_KEY
          },
          body: JSON.stringify({ code })
        });

        const json = await res.json();
        if (!res.ok) {
          showMsg(loginMsg, false, `❌ ${json.error || "Fehler"}`);
          return;
        }

        studentId = json.student.id;
        studentName = json.student.display_name;

        localStorage.setItem("student_id", studentId);
        localStorage.setItem("student_name", studentName);

        $("studentName").textContent = studentName;
        showMsg(loginMsg, true, `✅ Willkommen, <strong>${studentName}</strong>!`);
        $("logoutBtn").style.display = "inline-block";

        $("gameCard").style.display = "block";
        await loadHistory();
      } catch (e) {
        showMsg(loginMsg, false, `Netzwerkfehler: ${String(e)}`);
      }
    }

    async function logout(){
      localStorage.removeItem("student_id");
      localStorage.removeItem("student_name");
      studentId = null;
      studentName = null;
      $("logoutBtn").style.display = "none";
      $("gameCard").style.display = "none";
      await supabase.auth.signOut();
      showMsg(loginMsg, true, "Abgemeldet.");
    }

    $("claimBtn").addEventListener("click", claimCode);
    $("code").addEventListener("keydown", (e) => { if (e.key === "Enter") claimCode(); });
    $("logoutBtn").addEventListener("click", logout);

    $("smallBtn").addEventListener("click", () => startRun("small"));
    $("bigBtn").addEventListener("click", () => startRun("big"));
    $("okBtn").addEventListener("click", check);
    $("stopBtn").addEventListener("click", () => stop(false));
    $("answer").addEventListener("keydown", (e) => { if (e.key === "Enter") check(); });

    // Auto-restore (nur auf diesem Gerät)
    await ensureAnonSession();
    const savedId = localStorage.getItem("student_id");
    const savedName = localStorage.getItem("student_name");
    if (savedId && savedName) {
      studentId = savedId;
      studentName = savedName;
      $("studentName").textContent = studentName;
      $("logoutBtn").style.display = "inline-block";
      $("gameCard").style.display = "block";
      showMsg(loginMsg, true, `✅ Willkommen zurück, <strong>${studentName}</strong>`);
      await loadHistory();
    }
  </script>
</body>
</html>
