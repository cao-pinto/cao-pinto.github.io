<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lehrer ‚Äì Klassen & Ergebnisse</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:#f6f7fb; color:#111; }
    .wrap { max-width: 1100px; margin:0 auto; padding:24px; }
    .card { background:#fff; border-radius:14px; padding:18px; box-shadow:0 8px 24px rgba(0,0,0,.08); margin-top:14px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    input, select { padding:10px 12px; border-radius:10px; border:1px solid #ccd2e1; font-size:1rem; }
    button { padding:10px 14px; border-radius:10px; border:0; background:#1f6feb; color:#fff; font-weight:900; cursor:pointer; }
    button.ghost { background:#e5e7eb; color:#111; }
    .muted { opacity:.8; }
    .ok { background:#ecfdf5; border:1px solid #10b98144; padding:10px; border-radius:10px; }
    .bad { background:#fef2f2; border:1px solid #ef444444; padding:10px; border-radius:10px; }
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { text-align:left; padding:8px; border-bottom:1px solid #e5e7eb; vertical-align:top; }
    th { font-size:.9rem; opacity:.9; }
    a.ghost { text-decoration:none; padding:10px 14px; border-radius:10px; background:#e5e7eb; color:#111; font-weight:900; }
    code { background:#111827; color:#fff; padding:2px 6px; border-radius:6px; }
    textarea { width:100%; min-height:140px; border-radius:10px; border:1px solid #ccd2e1; padding:10px; font-family: inherit; }
    .danger { background:#fee2e2; color:#111; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 860px){ .grid2 { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <h1 style="margin:0;">Lehrer ‚Äì Klassen & Ergebnisse</h1>
        <a class="ghost" href="./index.html">‚Üê Startseite</a>
      </div>
      <p class="muted" style="margin:10px 0 0;">
        Sch√ºler verwalten (Codes), Ergebnisse ansehen, Reset, Sch√ºler/Klassen inkl. Login l√∂schen.
      </p>
    </div>

    <div class="card" id="loginCard">
      <h2 style="margin-top:0;">Lehrer Login</h2>
      <div class="row">
        <input id="email" placeholder="Lehrer Email" />
        <input id="pass" type="password" placeholder="Passwort" />
        <button id="loginBtn">Einloggen</button>
      </div>
      <div id="loginMsg" style="margin-top:10px;"></div>
    </div>

    <div class="card" id="teacherCard" style="display:none;">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="muted">Eingeloggt als:</div>
          <div style="font-weight:900; font-size:1.1rem;" id="teacherName">‚Äî</div>
        </div>
        <div class="row">
          <button class="ghost" id="refreshBtn">Aktualisieren</button>
          <button class="ghost" id="logoutBtn">Logout</button>
        </div>
      </div>

      <hr style="border:none;border-top:1px solid #e5e7eb; margin:14px 0;"/>

      <h2 style="margin:0 0 10px;">1) Klassen</h2>
      <div class="row">
        <input id="className" placeholder="Neue Klasse (z.B. 1A)" />
        <button id="createClassBtn">Klasse anlegen</button>
      </div>
      <div id="classMsg" style="margin-top:10px;"></div>
      <div id="classList" class="muted">‚Äî</div>

      <hr style="border:none;border-top:1px solid #e5e7eb; margin:14px 0;"/>

      <h2 style="margin:0 0 10px;">2) Sch√ºler (Codes)</h2>
      <div class="row">
        <select id="classSelect"></select>
        <input id="studentName" placeholder="Sch√ºler-Name/K√ºrzel (z.B. LK05)" />
        <button id="createStudentBtn">Sch√ºler + Code erstellen</button>
        <button class="ghost" id="createBatchBtn" title="Erstellt mehrere Sch√ºler auf einmal">Batch</button>
      </div>

      <div id="batchBox" style="display:none; margin-top:10px;">
        <textarea id="batchNames" placeholder="LK01&#10;LK02&#10;LK03"></textarea>
        <div class="row" style="margin-top:10px;">
          <button id="runBatchBtn">Batch erstellen</button>
          <button class="ghost" id="cancelBatchBtn">Abbrechen</button>
        </div>
      </div>

      <div id="studentMsg" style="margin-top:10px;"></div>
      <div id="studentList" class="muted">‚Äî</div>

      <hr style="border:none;border-top:1px solid #e5e7eb; margin:14px 0;"/>

      <h2 style="margin:0 0 10px;">3) Ergebnisse ‚Äì Mathematik</h2>
      <div class="muted">Bestwert richtig + √ò Accuracy (letzte 5) + beantwortet (letzte 5). Reset l√∂scht Attempts.</div>
      <div id="resultsMath" class="muted" style="margin-top:10px;">‚Äî</div>

      <hr style="border:none;border-top:1px solid #e5e7eb; margin:14px 0;"/>

      <h2 style="margin:0 0 10px;">4) Ergebnisse ‚Äì Bin√§rumwandlung</h2>
      <div class="muted">Bestwert richtig + √ò Accuracy (letzte 5) + beantwortet (letzte 5). Reset l√∂scht Attempts.</div>
      <div id="resultsBinary" class="muted" style="margin-top:10px;">‚Äî</div>

      <hr style="border:none;border-top:1px solid #e5e7eb; margin:14px 0;"/>

      <h2 style="margin:0 0 10px;">5) Ergebnisse ‚Äì Rechenbaum</h2>
      <div class="muted">
        Bestwerte: gel√∂ste B√§ume in 4 Varianten (0‚Äì10, 0‚Äì100, ‚àí10‚Ä¶+10, ‚àí100‚Ä¶+100). Reset l√∂scht Attempts.
      </div>
      <div id="resultsTree" class="muted" style="margin-top:10px;">‚Äî</div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://dnlencbwbbriijmzijci.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_G8SaY8-oyn7TcP-uH6neuA_PNqUR1x0";

    // Edge Functions (f√ºr Auth-User l√∂schen)
    const FN_TEACHER_DELETE_STUDENT = "https://dnlencbwbbriijmzijci.functions.supabase.co/teacher_delete_student";
    const FN_TEACHER_DELETE_CLASS   = "https://dnlencbwbbriijmzijci.functions.supabase.co/teacher_delete_class";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id) => document.getElementById(id);
    const loginCard = $("loginCard");
    const teacherCard = $("teacherCard");
    const loginMsg = $("loginMsg");
    const classMsg = $("classMsg");
    const studentMsg = $("studentMsg");
    const classSelect = $("classSelect");

    function msg(el, ok, text) { el.innerHTML = `<div class="${ok ? "ok" : "bad"}">${text}</div>`; }
    function escapeHtml(s) { return String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }
    function randCode(len=5){
      const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let out="";
      for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }

    let teacher = null;
    let classes = [];
    let studentsByClass = new Map();

    async function getTokenOrAlert(){
      const { data: sessionData } = await supabase.auth.getSession();
      const token = sessionData.session?.access_token;
      if (!token) { alert("Kein Login-Token. Bitte neu einloggen."); return null; }
      return token;
    }

    async function ensureUI() {
      const { data } = await supabase.auth.getSession();
      if (!data.session) {
        loginCard.style.display = "block";
        teacherCard.style.display = "none";
        return;
      }
      loginCard.style.display = "none";
      teacherCard.style.display = "block";
      await loadTeacher();
      await loadClasses();
      await loadStudentsForSelectedClass();
      await loadResultsForSelectedClass();
    }

    async function loadTeacher() {
      const { data: u } = await supabase.auth.getUser();
      const userId = u.user?.id;
      const { data, error } = await supabase.from("teachers").select("id,display_name").eq("user_id", userId).single();
      if (error) {
        $("teacherName").textContent = "Kein Teacher-Profil gefunden (Admin muss dich anlegen).";
        teacher = null;
        return;
      }
      teacher = data;
      $("teacherName").textContent = data.display_name;
    }

    async function loadClasses() {
      $("classList").textContent = "Lade Klassen‚Ä¶";
      const { data, error } = await supabase.from("classes").select("id,name,created_at").order("created_at", { ascending:false });
      if (error) { $("classList").innerHTML = `<div class="bad">Fehler: ${escapeHtml(error.message)}</div>`; return; }
      classes = data || [];

      classSelect.innerHTML = classes.length
        ? classes.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("")
        : `<option value="">(keine Klassen)</option>`;

      if (!classes.length) { $("classList").innerHTML = `<div class="muted">Noch keine Klassen.</div>`; return; }

      $("classList").innerHTML = `
        <table>
          <thead><tr><th>Klasse</th><th>ID</th><th>Erstellt</th><th>Aktion</th></tr></thead>
          <tbody>${classes.map(c => {
            const d = new Date(c.created_at).toLocaleString("de-AT");
            return `<tr>
              <td><strong>${escapeHtml(c.name)}</strong></td>
              <td class="muted">${c.id}</td>
              <td class="muted">${d}</td>
              <td>
                <button class="ghost danger" data-del-class="${c.id}" data-del-classname="${escapeHtml(c.name)}">
                  Klasse l√∂schen
                </button>
              </td>
            </tr>`;
          }).join("")}</tbody>
        </table>`;

      document.querySelectorAll("[data-del-class]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const cid = btn.getAttribute("data-del-class");
          const cname = btn.getAttribute("data-del-classname") || "Klasse";
          if (!cid) return;

          const ok = confirm(
            `Wirklich Klasse "${cname}" l√∂schen?\n` +
            `- Alle Sch√ºler dieser Klasse werden gel√∂scht\n` +
            `- Alle Logins (Auth-User) der Sch√ºler werden gel√∂scht\n` +
            `- Alle Ergebnisse (Mathe + Bin√§r + Rechenbaum) werden gel√∂scht\n` +
            `(Kann nicht r√ºckg√§ngig gemacht werden)`
          );
          if (!ok) return;

          const token = await getTokenOrAlert();
          if (!token) return;

          try {
            const res = await fetch(FN_TEACHER_DELETE_CLASS, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`,
                "apikey": SUPABASE_ANON_KEY
              },
              body: JSON.stringify({ class_id: cid })
            });

            const json = await res.json();
            if (!res.ok) {
              alert("Fehler beim L√∂schen: " + (json.error || "unbekannt") + (json.details ? " ‚Äì " + json.details : ""));
              return;
            }

            alert(`‚úÖ Klasse gel√∂scht: ${json.class_name || cname}\nAuth-User gel√∂scht: ${json.deleted_auth_users ?? 0}`);
            await loadClasses();
            await loadStudentsForSelectedClass();
            await loadResultsForSelectedClass();
          } catch (e) {
            alert("Netzwerkfehler: " + String(e));
          }
        });
      });
    }

    async function loadStudentsForSelectedClass() {
      const classId = classSelect.value;
      $("studentList").textContent = "Lade Sch√ºler‚Ä¶";
      if (!classId) { $("studentList").innerHTML = `<div class="muted">Bitte zuerst eine Klasse anlegen.</div>`; return; }

      const { data, error } = await supabase
        .from("students")
        .select("id,display_name,login_code,claimed_at,created_at")
        .eq("class_id", classId)
        .order("created_at", { ascending:false });

      if (error) { $("studentList").innerHTML = `<div class="bad">Fehler: ${escapeHtml(error.message)}</div>`; return; }

      const students = data || [];
      studentsByClass.set(classId, students);

      if (!students.length) { $("studentList").innerHTML = `<div class="muted">Noch keine Sch√ºler in dieser Klasse.</div>`; return; }

      $("studentList").innerHTML = `
        <table>
          <thead><tr><th>Name</th><th>Code</th><th>Status</th><th>Aktion</th></tr></thead>
          <tbody>${students.map(s => {
            const claimed = s.claimed_at ? "‚úÖ benutzt" : "üÜï neu";
            return `<tr>
              <td><strong>${escapeHtml(s.display_name)}</strong></td>
              <td><code>${escapeHtml(s.login_code)}</code></td>
              <td class="muted">${claimed}</td>
              <td>
                <button class="ghost danger" data-del-student="${s.id}" data-del-name="${escapeHtml(s.display_name)}">
                  Sch√ºler l√∂schen
                </button>
              </td>
            </tr>`;
          }).join("")}</tbody>
        </table>
      `;

      document.querySelectorAll("[data-del-student]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const sid = btn.getAttribute("data-del-student");
          const name = btn.getAttribute("data-del-name") || "Sch√ºler";
          if (!sid) return;

          const ok = confirm(`Wirklich "${name}" l√∂schen?\n- Login (Auth-User) wird gel√∂scht\n- Sch√ºler wird gel√∂scht\n- alle Ergebnisse (Mathe + Bin√§r + Rechenbaum) werden gel√∂scht\n(Das kann nicht r√ºckg√§ngig gemacht werden)`);
          if (!ok) return;

          const token = await getTokenOrAlert();
          if (!token) return;

          try {
            const res = await fetch(FN_TEACHER_DELETE_STUDENT, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`,
                "apikey": SUPABASE_ANON_KEY
              },
              body: JSON.stringify({ student_id: sid })
            });

            const json = await res.json();
            if (!res.ok) {
              alert("Fehler beim L√∂schen: " + (json.error || "unbekannt") + (json.details ? " ‚Äì " + json.details : ""));
              return;
            }

            alert(`‚úÖ Sch√ºler gel√∂scht. Auth-User gel√∂scht: ${json.deleted_auth_user ? "ja" : "nein (war nicht vorhanden)"}`);
            await loadStudentsForSelectedClass();
            await loadResultsForSelectedClass();
          } catch (e) {
            alert("Netzwerkfehler: " + String(e));
          }
        });
      });
    }

    function renderResultsTable(targetElId, title, rows, onResetClass, onResetStudent){
      const el = $(targetElId);
      if (!rows.length) {
        el.innerHTML = `<div class="muted">Noch keine Ergebnisse.</div>`;
        return;
      }
      el.innerHTML = `
        <div class="row" style="justify-content:space-between; margin-bottom:10px;">
          <div class="muted">${title}</div>
          <button class="ghost danger" id="${targetElId}_resetClassBtn">Statistik der Klasse zur√ºcksetzen</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Sch√ºler</th>
              <th>Bestwert</th>
              <th>√ò Accuracy (letzte 5)</th>
              <th>Beantwortet (letzte 5)</th>
              <th>Versuche</th>
              <th>Reset</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td><strong>${escapeHtml(r.name)}</strong></td>
                <td>${r.bestCorrect}</td>
                <td class="muted">${r.hasAcc ? (Math.round(r.avgAcc5*100) + "%") : "‚Äî"}</td>
                <td class="muted">${r.answered5}</td>
                <td class="muted">${r.n}</td>
                <td><button class="ghost danger" data-reset-student="${r.id}" data-rt="${targetElId}">Reset</button></td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;

      document.getElementById(`${targetElId}_resetClassBtn`)?.addEventListener("click", onResetClass);

      el.querySelectorAll("[data-reset-student]").forEach(btn => {
        btn.addEventListener("click", () => onResetStudent(btn.getAttribute("data-reset-student")));
      });
    }

    function renderTreeResults(targetElId, rows, onResetClass, onResetStudent){
      const el = $(targetElId);
      if (!rows.length) {
        el.innerHTML = `<div class="muted">Noch keine Ergebnisse.</div>`;
        return;
      }

      el.innerHTML = `
        <div class="row" style="justify-content:space-between; margin-bottom:10px;">
          <div class="muted">Bestwerte je Variante (gel√∂ste B√§ume)</div>
          <button class="ghost danger" id="${targetElId}_resetClassBtn">Rechenbaum der Klasse zur√ºcksetzen</button>
        </div>

        <table>
          <thead>
            <tr>
              <th>Sch√ºler</th>
              <th>Best 0‚Äì10</th>
              <th>Best 0‚Äì100</th>
              <th>Best ‚àí10‚Ä¶+10</th>
              <th>Best ‚àí100‚Ä¶+100</th>
              <th>Versuche</th>
              <th>Reset</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td><strong>${escapeHtml(r.name)}</strong></td>
                <td>${r.best10}</td>
                <td>${r.best100}</td>
                <td>${r.bestInt10}</td>
                <td>${r.bestInt100}</td>
                <td class="muted">${r.n}</td>
                <td><button class="ghost danger" data-reset-tree="${r.id}">Reset</button></td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;

      document.getElementById(`${targetElId}_resetClassBtn`)?.addEventListener("click", onResetClass);

      el.querySelectorAll("[data-reset-tree]").forEach(btn => {
        btn.addEventListener("click", () => onResetStudent(btn.getAttribute("data-reset-tree")));
      });
    }

    async function loadResultsForSelectedClass() {
      const classId = classSelect.value;
      $("resultsMath").textContent = "Lade Ergebnisse‚Ä¶";
      $("resultsBinary").textContent = "Lade Ergebnisse‚Ä¶";
      $("resultsTree").textContent = "Lade Ergebnisse‚Ä¶";

      if (!classId) {
        $("resultsMath").innerHTML = `<div class="muted">Bitte zuerst eine Klasse w√§hlen.</div>`;
        $("resultsBinary").innerHTML = `<div class="muted">Bitte zuerst eine Klasse w√§hlen.</div>`;
        $("resultsTree").innerHTML = `<div class="muted">Bitte zuerst eine Klasse w√§hlen.</div>`;
        return;
      }

      let students = studentsByClass.get(classId);
      if (!students) {
        const { data } = await supabase.from("students").select("id,display_name").eq("class_id", classId);
        students = data || [];
      }
      if (!students.length) {
        $("resultsMath").innerHTML = `<div class="muted">Noch keine Sch√ºler ‚Äì keine Ergebnisse.</div>`;
        $("resultsBinary").innerHTML = `<div class="muted">Noch keine Sch√ºler ‚Äì keine Ergebnisse.</div>`;
        $("resultsTree").innerHTML = `<div class="muted">Noch keine Sch√ºler ‚Äì keine Ergebnisse.</div>`;
        return;
      }

      const studentIds = students.map(s => s.id);

      const { data: attempts, error } = await supabase
        .from("attempts")
        .select("student_id,game,mode,correct_count,wrong_count,total_count,accuracy,created_at")
        .in("student_id", studentIds)
        .order("created_at", { ascending:false });

      if (error) {
        $("resultsMath").innerHTML = `<div class="bad">Fehler: ${escapeHtml(error.message)}</div>`;
        $("resultsBinary").innerHTML = `<div class="bad">Fehler: ${escapeHtml(error.message)}</div>`;
        $("resultsTree").innerHTML = `<div class="bad">Fehler: ${escapeHtml(error.message)}</div>`;
        return;
      }

      function computeRows(gameName){
        const byStudent = new Map();
        for (const s of students) byStudent.set(s.id, []);
        for (const a of (attempts || [])) byStudent.get(a.student_id)?.push(a);

        return students.map(s => {
          const list = (byStudent.get(s.id) || []).filter(x => x.game === gameName);
          const bestCorrect = list.reduce((m, x) => Math.max(m, x.correct_count), 0);
          const last5 = list.slice(0,5);
          const hasAcc = (gameName !== "tree");
          const avgAcc5 = last5.length ? (last5.reduce((sum,x)=>sum+Number(x.accuracy ?? 0),0)/last5.length) : 0;
          const answered5 = last5.reduce((sum,x)=>sum + Number(x.total_count ?? (x.correct_count + (x.wrong_count ?? 0))), 0);
          return { id: s.id, name: s.display_name, bestCorrect, avgAcc5, answered5, n: list.length, hasAcc };
        }).sort((a,b)=> b.bestCorrect - a.bestCorrect || b.avgAcc5 - a.avgAcc5 || a.name.localeCompare(b.name));
      }

      const rowsMath = computeRows("math");
      const rowsBinary = computeRows("binary");

      renderResultsTable(
        "resultsMath",
        "Mathematik (Einmaleins)",
        rowsMath,
        async () => {
          const ok = confirm("Wirklich ALLE Mathe-Statistiken dieser Klasse l√∂schen?");
          if (!ok) return;
          const ids = students.map(s => s.id);
          const { error } = await supabase.from("attempts").delete().eq("game","math").in("student_id", ids);
          if (error) return alert("Fehler: " + error.message);
          alert("‚úÖ Mathe-Statistik zur√ºckgesetzt.");
          await loadResultsForSelectedClass();
        },
        async (sid) => {
          if (!sid) return;
          const ok = confirm("Wirklich die Mathe-Statistik dieses Sch√ºlers l√∂schen?");
          if (!ok) return;
          const { error } = await supabase.from("attempts").delete().eq("game","math").eq("student_id", sid);
          if (error) return alert("Fehler: " + error.message);
          alert("‚úÖ Mathe-Statistik zur√ºckgesetzt.");
          await loadResultsForSelectedClass();
        }
      );

      renderResultsTable(
        "resultsBinary",
        "Bin√§rumwandlung",
        rowsBinary,
        async () => {
          const ok = confirm("Wirklich ALLE Bin√§r-Statistiken dieser Klasse l√∂schen?");
          if (!ok) return;
          const ids = students.map(s => s.id);
          const { error } = await supabase.from("attempts").delete().eq("game","binary").in("student_id", ids);
          if (error) return alert("Fehler: " + error.message);
          alert("‚úÖ Bin√§r-Statistik zur√ºckgesetzt.");
          await loadResultsForSelectedClass();
        },
        async (sid) => {
          if (!sid) return;
          const ok = confirm("Wirklich die Bin√§r-Statistik dieses Sch√ºlers l√∂schen?");
          if (!ok) return;
          const { error } = await supabase.from("attempts").delete().eq("game","binary").eq("student_id", sid);
          if (error) return alert("Fehler: " + error.message);
          alert("‚úÖ Bin√§r-Statistik zur√ºckgesetzt.");
          await loadResultsForSelectedClass();
        }
      );

      // Tree results (4 modes)
      const byStudentTree = new Map();
      for (const s of students) byStudentTree.set(s.id, []);
      for (const a of (attempts || [])) if (a.game === "tree") byStudentTree.get(a.student_id)?.push(a);

      const rowsTree = students.map(s => {
        const list = byStudentTree.get(s.id) || [];
        const best10 = Math.max(0, ...list.filter(x => x.mode === "tree10").map(x => x.correct_count));
        const best100 = Math.max(0, ...list.filter(x => x.mode === "tree100").map(x => x.correct_count));
        const bestInt10 = Math.max(0, ...list.filter(x => x.mode === "treeInt10").map(x => x.correct_count));
        const bestInt100 = Math.max(0, ...list.filter(x => x.mode === "treeInt100").map(x => x.correct_count));
        return { id: s.id, name: s.display_name, best10, best100, bestInt10, bestInt100, n: list.length };
      }).sort((a,b)=> (b.best10+b.best100+b.bestInt10+b.bestInt100) - (a.best10+a.best100+a.bestInt10+a.bestInt100) || a.name.localeCompare(b.name));

      renderTreeResults(
        "resultsTree",
        rowsTree,
        async () => {
          const ok = confirm("Wirklich ALLE Rechenbaum-Ergebnisse dieser Klasse l√∂schen?");
          if (!ok) return;
          const ids = students.map(s => s.id);
          const { error } = await supabase.from("attempts").delete().eq("game","tree").in("student_id", ids);
          if (error) return alert("Fehler: " + error.message);
          alert("‚úÖ Rechenbaum-Statistik zur√ºckgesetzt.");
          await loadResultsForSelectedClass();
        },
        async (sid) => {
          if (!sid) return;
          const ok = confirm("Wirklich die Rechenbaum-Statistik dieses Sch√ºlers l√∂schen?");
          if (!ok) return;
          const { error } = await supabase.from("attempts").delete().eq("game","tree").eq("student_id", sid);
          if (error) return alert("Fehler: " + error.message);
          alert("‚úÖ Rechenbaum-Statistik zur√ºckgesetzt.");
          await loadResultsForSelectedClass();
        }
      );
    }

    $("loginBtn").addEventListener("click", async () => {
      loginMsg.textContent = "";
      const email = $("email").value.trim();
      const password = $("pass").value.trim();
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) msg(loginMsg, false, `Login fehlgeschlagen: ${escapeHtml(error.message)}`);
      else msg(loginMsg, true, "‚úÖ Eingeloggt.");
      await ensureUI();
    });

    $("logoutBtn").addEventListener("click", async () => { await supabase.auth.signOut(); await ensureUI(); });

    $("refreshBtn").addEventListener("click", async () => {
      await loadClasses();
      await loadStudentsForSelectedClass();
      await loadResultsForSelectedClass();
    });

    $("createClassBtn").addEventListener("click", async () => {
      classMsg.textContent = "";
      const name = $("className").value.trim();
      if (!name) return msg(classMsg, false, "Bitte Klassenname eingeben.");
      if (!teacher?.id) return msg(classMsg, false, "Teacher-Profil fehlt. Admin muss dich anlegen.");

      const { error } = await supabase.from("classes").insert({ teacher_id: teacher.id, name });
      if (error) msg(classMsg, false, `Fehler: ${escapeHtml(error.message)}`);
      else msg(classMsg, true, "‚úÖ Klasse angelegt.");
      $("className").value = "";
      await loadClasses();
      await loadStudentsForSelectedClass();
      await loadResultsForSelectedClass();
    });

    $("createStudentBtn").addEventListener("click", async () => {
      studentMsg.textContent = "";
      const classId = classSelect.value;
      const display_name = $("studentName").value.trim();
      if (!classId) return msg(studentMsg, false, "Bitte Klasse w√§hlen.");
      if (!display_name) return msg(studentMsg, false, "Bitte Sch√ºlername/K√ºrzel eingeben.");

      let code = randCode(5);
      for (let i=0;i<6;i++){
        const { data: existing } = await supabase.from("students").select("id").eq("login_code", code).maybeSingle();
        if (!existing) break;
        code = randCode(5);
      }

      const { error } = await supabase.from("students").insert({ class_id: classId, display_name, login_code: code });
      if (error) msg(studentMsg, false, `Fehler: ${escapeHtml(error.message)}`);
      else msg(studentMsg, true, `‚úÖ Sch√ºler erstellt. Code: <code>${escapeHtml(code)}</code>`);
      $("studentName").value = "";
      await loadStudentsForSelectedClass();
      await loadResultsForSelectedClass();
    });

    $("createBatchBtn").addEventListener("click", () => $("batchBox").style.display = "block");
    $("cancelBatchBtn").addEventListener("click", () => { $("batchBox").style.display="none"; $("batchNames").value=""; });

    $("runBatchBtn").addEventListener("click", async () => {
      studentMsg.textContent = "";
      const classId = classSelect.value;
      if (!classId) return msg(studentMsg, false, "Bitte Klasse w√§hlen.");

      const lines = $("batchNames").value.split("\n").map(x => x.trim()).filter(Boolean);
      if (!lines.length) return msg(studentMsg, false, "Bitte mindestens einen Namen eingeben.");

      let okCount = 0;
      for (const display_name of lines) {
        let code = randCode(5);
        for (let i=0;i<6;i++){
          const { data: existing } = await supabase.from("students").select("id").eq("login_code", code).maybeSingle();
          if (!existing) break;
          code = randCode(5);
        }
        const { error } = await supabase.from("students").insert({ class_id: classId, display_name, login_code: code });
        if (!error) okCount++;
      }

      msg(studentMsg, true, `‚úÖ Batch fertig: ${okCount}/${lines.length} erstellt.`);
      $("batchBox").style.display="none";
      $("batchNames").value="";
      await loadStudentsForSelectedClass();
      await loadResultsForSelectedClass();
    });

    classSelect.addEventListener("change", async () => {
      await loadStudentsForSelectedClass();
      await loadResultsForSelectedClass();
    });

    await ensureUI();
  </script>
</body>
</html>
