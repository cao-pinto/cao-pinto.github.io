<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin – Lehrer verwalten</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:#f6f7fb; color:#111; }
    .wrap { max-width: 980px; margin:0 auto; padding:24px; }
    .card { background:#fff; border-radius:14px; padding:18px; box-shadow:0 8px 24px rgba(0,0,0,.08); margin-top:14px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    input { padding:10px 12px; border-radius:10px; border:1px solid #ccd2e1; font-size:1rem; min-width:240px; }
    button { padding:10px 14px; border-radius:10px; border:0; background:#1f6feb; color:#fff; font-weight:900; cursor:pointer; }
    button.ghost { background:#e5e7eb; color:#111; }
    .muted { opacity:.8; }
    .ok { background:#ecfdf5; border:1px solid #10b98144; padding:10px; border-radius:10px; }
    .bad { background:#fef2f2; border:1px solid #ef444444; padding:10px; border-radius:10px; }
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { text-align:left; padding:8px; border-bottom:1px solid #e5e7eb; }
    th { font-size:.9rem; opacity:.9; }
    a.ghost { text-decoration:none; padding:10px 14px; border-radius:10px; background:#e5e7eb; color:#111; font-weight:900; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <h1 style="margin:0;">Admin – Lehrer verwalten</h1>
        <a class="ghost" href="./index.html">← Startseite</a>
      </div>
      <p class="muted" style="margin:10px 0 0;">
        Admin-Login (Email/Passwort). Danach kannst du Lehrer-Accounts erstellen.
      </p>
    </div>

    <div class="card" id="loginCard">
      <h2 style="margin-top:0;">Admin Login</h2>
      <div class="row">
        <input id="email" placeholder="Admin Email" />
        <input id="pass" type="password" placeholder="Passwort" />
        <button id="loginBtn">Einloggen</button>
      </div>
      <div id="loginMsg" style="margin-top:10px;"></div>
    </div>

    <div class="card" id="adminCard" style="display:none;">
      <div class="row" style="justify-content:space-between;">
        <h2 style="margin:0;">Lehrer anlegen</h2>
        <div class="row">
          <button class="ghost" id="refreshBtn">Liste aktualisieren</button>
          <button class="ghost" id="logoutBtn">Logout</button>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <input id="tName" placeholder="Anzeigename (z.B. Frau Huber)" />
        <input id="tEmail" placeholder="Lehrer Email" />
        <input id="tPass" type="password" placeholder="Lehrer Passwort (neu)" />
        <button id="createTeacherBtn">Lehrer erstellen</button>
      </div>

      <div id="createMsg" style="margin-top:10px;"></div>

      <h3 style="margin:16px 0 0;">Lehrer-Liste</h3>
      <div id="teacherList" class="muted">—</div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // Fix eingetragen
    const SUPABASE_URL = "https://dnlencbwbbriijmzijci.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_G8SaY8-oyn7TcP-uH6neuA_PNqUR1x0";

    // Fix eingetragen
    const FN_ADMIN_CREATE_TEACHER = "https://dnlencbwbbriijmzijci.functions.supabase.co/admin_create_teacher";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id) => document.getElementById(id);
    const loginCard = $("loginCard");
    const adminCard = $("adminCard");
    const loginMsg = $("loginMsg");
    const createMsg = $("createMsg");
    const teacherList = $("teacherList");

    function msg(el, ok, text) {
      el.innerHTML = `<div class="${ok ? "ok" : "bad"}">${text}</div>`;
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    async function ensureSessionUI() {
      const { data } = await supabase.auth.getSession();
      if (data.session) {
        loginCard.style.display = "none";
        adminCard.style.display = "block";
        await loadTeachers();
      } else {
        loginCard.style.display = "block";
        adminCard.style.display = "none";
      }
    }

    async function loadTeachers() {
      teacherList.textContent = "Lade…";
      const { data, error } = await supabase
        .from("teachers")
        .select("id,user_id,display_name,created_at")
        .order("created_at", { ascending: false });

      if (error) {
        teacherList.innerHTML = `<div class="bad">Fehler: ${escapeHtml(error.message)}</div>`;
        return;
      }

      if (!data?.length) {
        teacherList.innerHTML = `<div class="muted">Keine Lehrer gefunden.</div>`;
        return;
      }

      teacherList.innerHTML = `
        <table>
          <thead><tr><th>Name</th><th>Teacher ID</th><th>User ID</th><th>Erstellt</th></tr></thead>
          <tbody>
            ${data.map(t => {
              const d = new Date(t.created_at).toLocaleString("de-AT");
              return `<tr>
                <td><strong>${escapeHtml(t.display_name)}</strong></td>
                <td>${t.id}</td>
                <td>${t.user_id}</td>
                <td class="muted">${d}</td>
              </tr>`;
            }).join("")}
          </tbody>
        </table>
      `;
    }

    $("loginBtn").addEventListener("click", async () => {
      loginMsg.textContent = "";
      const email = $("email").value.trim();
      const password = $("pass").value.trim();

      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) msg(loginMsg, false, `Login fehlgeschlagen: ${escapeHtml(error.message)}`);
      else msg(loginMsg, true, "✅ Eingeloggt.");
      await ensureSessionUI();
    });

    $("logoutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      await ensureSessionUI();
    });

    $("refreshBtn").addEventListener("click", loadTeachers);

    $("createTeacherBtn").addEventListener("click", async () => {
      createMsg.textContent = "";

      const display_name = $("tName").value.trim();
      const email = $("tEmail").value.trim();
      const password = $("tPass").value.trim();
      if (!display_name || !email || !password) {
        msg(createMsg, false, "Bitte Anzeigename, Email und Passwort eingeben.");
        return;
      }

      const { data: sessionData } = await supabase.auth.getSession();
      const token = sessionData.session?.access_token;
      if (!token) {
        msg(createMsg, false, "Kein Login-Token gefunden. Bitte neu einloggen.");
        return;
      }

      try {
        const res = await fetch(FN_ADMIN_CREATE_TEACHER, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ email, password, display_name })
        });

        const json = await res.json();
        if (!res.ok) {
          msg(createMsg, false, `Fehler: ${escapeHtml(json.error || "unbekannt")}${json.details ? " – " + escapeHtml(json.details) : ""}`);
          return;
        }

        msg(createMsg, true, `✅ Lehrer erstellt: <strong>${escapeHtml(json.teacher.display_name)}</strong>`);
        $("tName").value = "";
        $("tEmail").value = "";
        $("tPass").value = "";
        await loadTeachers();
      } catch (e) {
        msg(createMsg, false, `Netzwerkfehler: ${escapeHtml(String(e))}`);
      }
    });

    await ensureSessionUI();
  </script>
</body>
</html>
